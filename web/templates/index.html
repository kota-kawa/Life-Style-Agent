<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Q&A Chat System</title>
  <link
    rel="icon"
    type="image/png"
    href="{{ url_for('static', filename='favicon/home-assistant-favicon.png') }}"
    sizes="512x512"
  />
  <link
    rel="icon"
    type="image/x-icon"
    href="{{ url_for('static', filename='favicon/home-assistant-favicon.ico') }}"
  />
  <link
    rel="apple-touch-icon"
    href="{{ url_for('static', filename='favicon/home-assistant-favicon.png') }}"
  />
  <style>
    :root {
      --primary: #4f9aff;
      --primary-dark: #3a7dd4;
      --bg: #f0f4fb;
      --card-bg: #ffffff;
      --user-msg: #cee4ff;
      --bot-msg: #e5e5ea;
      --radius: 12px;
      --transition: 0.3s ease;
    }
    * {
      box-sizing: border-box;
      margin: 0; padding: 0;
      font-family: "Söhne", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", "Noto Sans JP", "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
    }
    body {
      background: var(--bg);
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; padding: 20px;
    }

    /* ===== コンテナ ===== */
    .container {
      width: 100%;
      max-width: 960px;
      max-height: 80vh;            /* 画面高さの80%を上限に */
      display: flex;
      flex-direction: column;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
      overflow: hidden;            /* はみ出し部分を隠す */
    }
    .header {
      background: var(--primary);
      color: #fff;
      padding: 16px;
      text-align: center;
      font-size: 1.2rem;
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #model-selector {
      font-size: 0.9rem;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #fff;
      background: var(--primary-dark);
      color: #fff;
      cursor: pointer;
    }
    .header .reset-btn {
      position: static;
      transform: none;
      background: none; border: none;
      color: #fff; cursor: pointer; font-size: 1.2rem;
      transition: transform var(--transition);
    }
    .header .reset-btn:hover {
      transform: translateY(-50%) rotate(90deg);
    }

    .summary-panel {
      padding: 16px;
      background: #f6f8ff;
      border-bottom: 1px solid #e1e8ff;
      transition: border-color var(--transition), background var(--transition);
    }
    .summary-panel.collapsed {
      border-bottom-color: transparent;
      background: #f1f4ff;
    }
    .summary-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }
    .summary-title {
      font-weight: bold;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
    }
    .summary-title::before {
      content: '\1F4AC';
    }
    .summary-toggle {
      background: none;
      border: none;
      display: flex;
      align-items: center;
      color: var(--primary-dark);
      font-size: 0.85rem;
      gap: 4px;
      cursor: pointer;
      transition: color var(--transition), transform var(--transition);
    }
    .summary-toggle-icon {
      display: inline-flex;
      width: 16px;
      height: 16px;
      align-items: center;
      justify-content: center;
      transform-origin: center;
      transition: transform var(--transition);
    }
    .summary-panel.collapsed .summary-toggle-icon {
      transform: rotate(-90deg);
    }
    .summary-content {
      font-size: 0.95rem;
      line-height: 1.6;
      color: #333;
      white-space: pre-wrap;
      word-break: break-word;
      margin-top: 8px;
      transition: max-height var(--transition), opacity var(--transition);
      max-height: 320px;
      overflow: hidden;
      opacity: 1;
    }
    .summary-panel.collapsed .summary-content {
      max-height: 0;
      opacity: 0;
      margin-top: 0;
      pointer-events: none;
    }
    .summary-panel.loading .summary-content {
      color: #666;
      font-style: italic;
    }

    /* ===== チャット領域 ===== */
    .chat-box {
      flex: 1;
      max-height: 60vh;            /* 画面高さの60%を上限に */
      padding: 16px;
      overflow-y: auto;
      background: #fafcff;
      scrollbar-width: thin;
      scrollbar-color: rgba(0,0,0,0.2) transparent;
    }
    .chat-box::-webkit-scrollbar { width: 6px; }
    .chat-box::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.2);
      border-radius: 3px;
    }

    /* ===== メッセージ ===== */
    .message {
      display: flex; margin: 8px 0; opacity: 0;
    }
    .message.user {
      justify-content: flex-end;
      animation: slideInRight 0.4s forwards;
    }
    .message.bot {
      justify-content: flex-start;
      animation: slideInLeft 0.4s forwards;
    }
    .text {
      position: relative;           /* スピナー配置用 */
      max-width: 70%;
      padding: 12px 16px;
      border-radius: var(--radius);
      line-height: 1.4;
      transition: background var(--transition);
    }
    .message.user .text { background: var(--user-msg); }
    .message.bot  .text { background: var(--bot-msg);  }

    /* Markdown & Bot Message Styling */
    .message.bot .text {
      font-weight: 500;
      line-height: 1.6;
    }
    .message.bot .text h1, .message.bot .text h2, .message.bot .text h3, .message.bot .text h4, .message.bot .text h5, .message.bot .text h6 {
      font-weight: 700;
      margin-top: 1.2em;
      margin-bottom: 0.6em;
      line-height: 1.3;
    }
    .message.bot .text h1 { font-size: 1.5em; border-bottom: 1px solid #ccc; padding-bottom: 0.3em; }
    .message.bot .text h2 { font-size: 1.3em; }
    .message.bot .text h3 { font-size: 1.1em; }
    .message.bot .text p { margin-bottom: 1em; }
    .message.bot .text p:last-child { margin-bottom: 0; }
    .message.bot .text ul, .message.bot .text ol { margin-left: 1.5em; margin-bottom: 1em; }
    .message.bot .text li { margin-bottom: 0.3em; }
    .message.bot .text strong, .message.bot .text b { font-weight: 700; }
    .message.bot .text code {
      background: rgba(0,0,0,0.08);
      padding: 2px 5px;
      border-radius: 4px;
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 0.9em;
    }
    .message.bot .text pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      margin-bottom: 1em;
    }
    .message.bot .text pre code { background: none; padding: 0; color: inherit; }
    .message.bot .text blockquote {
      border-left: 4px solid #ccc;
      padding-left: 1em;
      color: #555;
      margin-bottom: 1em;
    }
    .message.bot .text table {
      border-collapse: collapse;
      margin: 1em 0;
      width: 100%;
      font-size: 0.95em;
    }
    .message.bot .text th, .message.bot .text td {
      border: 1px solid #c8c8c8;
      padding: 8px 12px;
      text-align: left;
    }
    .message.bot .text th { background-color: #e0e0e0; font-weight: 600; }

    @keyframes slideInLeft {
      from { transform: translateX(-30px); opacity: 0; }
      to   { transform: translateX(0);     opacity: 1; }
    }
    @keyframes slideInRight {
      from { transform: translateX(30px);  opacity: 0; }
      to   { transform: translateX(0);     opacity: 1; }
    }

    /* ===== 入力エリア ===== */
    .input-area {
      display: flex;
      padding: 12px;
      background: #fff;
      border-top: 1px solid #eee;
    }
    .input-area input {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: var(--radius) 0 0 var(--radius);
      transition: border-color var(--transition);
    }
    .input-area input:focus {
      border-color: var(--primary);
      outline: none;
    }
    .input-area button {
      width: 60px;
      border: none;
      background: var(--primary);
      color: #fff;
      border-radius: 0 var(--radius) var(--radius) 0;
      cursor: pointer;
      display: flex; justify-content: center; align-items: center;
      transition: background var(--transition), transform var(--transition);
    }
    .input-area button svg {
      width: 20px; height: 20px;
      transform: rotate(0deg);
      transition: transform var(--transition);
    }
    .input-area button:active {
      background: var(--primary-dark);
    }
    .input-area button:active svg {
      transform: rotate(45deg);
    }

    /* ===== スピナー (チャット内) ===== */
    .spinner-wrapper {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
    }
    .spinner {
      box-sizing: border-box;
      width: 20px; height: 20px;
      border: 3px solid rgba(0,0,0,0.1);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <span>Q&A Chat System</span>
      <select id="model-selector">
        <optgroup label="OpenAI">
          <option value='{"provider": "openai", "model": "gpt-5.1"}'>GPT-5.1</option>
        </optgroup>
        <optgroup label="Gemini (Google)">
          <option value='{"provider": "gemini", "model": "gemini-2.5-flash-lite"}'>Gemini 2.5 Flash-Lite</option>
          <option value='{"provider": "gemini", "model": "gemini-3-pro-preview"}'>Gemini 3 Pro Preview</option>
        </optgroup>
        <optgroup label="Claude (Anthropic)">
          <option value='{"provider": "claude", "model": "claude-haiku-4-5"}'>Claude Haiku 4.5</option>
          <option value='{"provider": "claude", "model": "claude-opus-4-5"}'>Claude Opus 4.5</option>
        </optgroup>
        <optgroup label="Groq">
          <option value='{"provider": "groq", "model": "llama-3.3-70b-versatile"}'>Llama 3.3 70B (Groq)</option>
          <option value='{"provider": "groq", "model": "llama-3.1-8b-instant"}'>Llama 3.1 8B (Groq)</option>
          <option value='{"provider": "groq", "model": "openai/gpt-oss-20b"}'>GPT-OSS 20B (Groq)</option>
          <option value='{"provider": "groq", "model": "qwen/qwen3-32b"}'>Qwen3 32B (Groq)</option>
        </optgroup>
      </select>
      <button class="reset-btn" title="リセット">&#x21bb;</button>
    </div>
    <div id="summary-panel" class="summary-panel">
      <div class="summary-header" id="summary-toggle">
        <div class="summary-title">会話の要約</div>
        <button type="button" class="summary-toggle" aria-expanded="true" aria-controls="conversation-summary">
          <span class="summary-toggle-label">閉じる</span>
          <span class="summary-toggle-icon">&#9650;</span>
        </button>
      </div>
      <div id="conversation-summary" class="summary-content" role="region" aria-live="polite">まだ会話はありません。</div>
    </div>
    <div id="chat" class="chat-box"></div>
    <form id="chat-form" class="input-area">
      <input type="text" id="question" placeholder="質問を入力してください…" autocomplete="off" required />
      <button type="submit" title="送信">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
        </svg>
      </button>
    </form>
  </div>

  <script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
  <script>
    const chatBox = document.getElementById('chat');
    const form    = document.getElementById('chat-form');
    const input   = document.getElementById('question');
    const modelSelector = document.getElementById('model-selector');
    const resetBtn= document.querySelector('.reset-btn');
    const summaryPanel = document.getElementById('summary-panel');
    const summaryContent = document.getElementById('conversation-summary');
    const summaryToggle = document.getElementById('summary-toggle');
    const summaryToggleButton = summaryToggle.querySelector('.summary-toggle');
    const summaryToggleLabel = summaryToggleButton.querySelector('.summary-toggle-label');
    const summaryToggleIcon = summaryToggleButton.querySelector('.summary-toggle-icon');
    const DEFAULT_SUMMARY_TEXT = 'まだ会話はありません。';
    const DEFAULT_MODEL_SELECTION = { provider: 'openai', model: 'gpt-5.1' };

    async function hydrateModelSelector() {
      if (!modelSelector) return;
      try {
        const res = await fetch('/model_settings', { cache: 'no-store' });
        if (!res.ok) throw new Error('failed to load model selection');
        const data = await res.json();
        const selection = (data && typeof data === 'object')
          ? (data.selection || data)
          : DEFAULT_MODEL_SELECTION;
        const targetProvider = selection.provider || DEFAULT_MODEL_SELECTION.provider;
        const targetModel = selection.model || DEFAULT_MODEL_SELECTION.model;
        let matched = false;
        Array.from(modelSelector.options).forEach(option => {
          try {
            const value = JSON.parse(option.value);
            if (value.provider === targetProvider && value.model === targetModel) {
              option.selected = true;
              matched = true;
            }
          } catch (err) {
            /* ignore malformed options */
          }
        });
        if (!matched && modelSelector.options.length) {
          modelSelector.selectedIndex = 0;
        }
      } catch (err) {
        console.error('モデル選択状態の取得に失敗しました:', err);
        if (modelSelector.options.length) {
          modelSelector.selectedIndex = 0;
        }
      }
    }

    modelSelector.addEventListener('change', async (e) => {
      try {
        const selection = JSON.parse(e.target.value);
        const res = await fetch('/model_settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(selection)
        });
        if (!res.ok) throw new Error('Failed to update model');
        console.log('Model updated successfully');
      } catch (err) {
        console.error('Error updating model:', err);
        alert('モデルの切り替えに失敗しました。');
      }
    });

    hydrateModelSelector();

    async function fetchHistory() {
      try {
        const res = await fetch('/conversation_history');
        if (!res.ok) throw new Error('failed to load history');
        const data = await res.json();
        const history = Array.isArray(data.conversation_history) ? data.conversation_history : [];
        chatBox.innerHTML = '';
        history.forEach(entry => {
          const role = (entry.role || '').toLowerCase() === 'user' ? 'user' : 'bot';
          appendMessage(role, entry.message || '');
        });
      } catch (err) {
        console.error('会話履歴の取得に失敗しました:', err);
      }
    }

    async function refreshSummary({ showLoading = false } = {}) {
      if (showLoading) {
        summaryPanel.classList.add('loading');
        summaryContent.textContent = '要約を更新しています…';
      }
      try {
        const res = await fetch('/conversation_summary');
        if (!res.ok) throw new Error('failed to summarize');
        const data = await res.json();
        if (data.summary) {
          summaryContent.textContent = data.summary;
        } else if (data.error) {
          summaryContent.textContent = '要約の取得に失敗しました: ' + data.error;
        } else {
          summaryContent.textContent = DEFAULT_SUMMARY_TEXT;
        }
      } catch (err) {
        console.error('要約の取得に失敗しました:', err);
        summaryContent.textContent = '要約の取得中にエラーが発生しました。';
      } finally {
        summaryPanel.classList.remove('loading');
      }
    }

    function updateSummaryToggle(isCollapsed) {
      summaryPanel.classList.toggle('collapsed', isCollapsed);
      summaryToggleButton.setAttribute('aria-expanded', String(!isCollapsed));
      summaryToggleLabel.textContent = isCollapsed ? '開く' : '閉じる';
      summaryToggleIcon.innerHTML = isCollapsed ? '&#9660;' : '&#9650;';
    }

    summaryToggle.addEventListener('click', () => {
      const isCurrentlyCollapsed = summaryPanel.classList.contains('collapsed');
      updateSummaryToggle(!isCurrentlyCollapsed);
    });

    fetchHistory();
    refreshSummary({ showLoading: true });

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const q = input.value.trim();
      if (!q) return;
      appendMessage('user', q);
      input.value = '';
      // スピナー付きの空メッセージを追加
      const placeholder = appendSpinnerMessage();
      try {
        const res = await fetch('/rag_answer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: q })
        });
        const { answer } = await res.json();
        replaceSpinnerMessage(placeholder, answer);
        await refreshSummary();
      } catch (err) {
        replaceSpinnerMessage(placeholder, 'エラー: ' + err.message);
      }
    });

    resetBtn.addEventListener('click', async () => {
      if (!confirm('会話履歴をリセットしますか？')) return;
      try {
        const res = await fetch('/reset_history', { method: 'POST' });
        const { status } = await res.json();
        if (status) {
          chatBox.innerHTML = '';
          summaryContent.textContent = DEFAULT_SUMMARY_TEXT;
          await refreshSummary({ showLoading: true });
        }
        else alert('リセットに失敗しました。');
      } catch (err) {
        alert('リセット中にエラー: ' + err.message);
      }
    });

    function appendMessage(sender, text) {
      const m = document.createElement('div');
      m.className = 'message ' + sender;
      const t = document.createElement('div');
      t.className = 'text';
      if (sender === 'bot') {
        if (typeof marked !== 'undefined') {
          t.innerHTML = marked.parse(text || '');
        } else {
          t.innerHTML = text;
        }
      } else {
        t.textContent = text;
      }
      m.appendChild(t);
      chatBox.appendChild(m);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function appendSpinnerMessage() {
      const m = document.createElement('div');
      m.className = 'message bot';
      const t = document.createElement('div');
      t.className = 'text';
      t.style.minHeight = '24px';  // 高さを確保
      const wrapper = document.createElement('div');
      wrapper.className = 'spinner-wrapper';
      const spinner = document.createElement('div');
      spinner.className = 'spinner';
      wrapper.appendChild(spinner);
      t.appendChild(wrapper);
      m.appendChild(t);
      chatBox.appendChild(m);
      chatBox.scrollTop = chatBox.scrollHeight;
      return m;
    }

    function replaceSpinnerMessage(msgElem, text) {
      const t = msgElem.querySelector('.text');
      if (typeof marked !== 'undefined') {
        t.innerHTML = marked.parse(text || '');
      } else {
        t.innerHTML = text;
      }
    }
  </script>
</body>
</html>
